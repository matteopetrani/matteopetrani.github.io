name: Notify Telegram on new post

on:
  push:
    branches:
      - main
      - master
    paths:
      - "_posts/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Send Telegram notifications for new posts
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
        run: |
          first_words() {
            local file="$1"
            local limit="${2:-50}"
            local body
            body=$(awk '
              BEGIN { front=0 }
              /^---[ \t]*$/ {
                front++
                next
              }
              {
                if (front >= 2) { print }
              }
            ' "$file")

            body=$(printf '%s' "$body" | sed 's/{%[^%]*%}//g' | tr '\n' ' ')
            body=$(printf '%s' "$body" | sed 's/[[:space:]]\+/ /g; s/^ //; s/ $//')

            if [ -z "$body" ]; then
              printf 'Nuovo post sul blog...'
              return
            fi

            local snippet
            snippet=$(printf '%s\n' "$body" | awk -v limit="$limit" '{
              out=""
              for (i = 1; i <= NF && i <= limit; i++) {
                out = out (i == 1 ? "" : " ") $i
              }
              print out
            }')

            if [ -z "$snippet" ]; then
              printf 'Nuovo post sul blog...'
            else
              printf '%s...' "$snippet"
            fi
          }

          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ] || [ -z "${SITE_BASE_URL}" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID or SITE_BASE_URL secrets."
            exit 1
          fi

          BEFORE_SHA="${{ github.event.before }}"

          # Collect file list for the push range when available, otherwise fall back to latest commit only
          if [ -n "$BEFORE_SHA" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
            DIFF_OUTPUT=$(git diff --name-status "$BEFORE_SHA" "${GITHUB_SHA}")
          else
            DIFF_OUTPUT=$(git show --name-status --pretty="" "${GITHUB_SHA}")
          fi

          # Find only newly added posts (status "A") within the push range
          CHANGED_POSTS=$(printf '%s\n' "$DIFF_OUTPUT" | awk '$1 == "A" {print $2}' | grep '^_posts/' || true)

          if [ -z "$CHANGED_POSTS" ]; then
            echo "No changed posts found."
            exit 0
          fi

          for FILE in $CHANGED_POSTS; do
            if [ ! -f "$FILE" ]; then
              continue
            fi

            # Extract title from front matter (first 'title:' line)
            TITLE=$(awk '/^title:/ {sub(/^title:[ ]*/, "", $0); print; exit}' "$FILE")
            [ -z "$TITLE" ] && TITLE="Nuovo post"

            # Extract telegram text from front matter.
            TELEGRAM_TEXT=$(awk '
              /^telegram:/ {
                sub(/^telegram:[ ]*/, "", $0);
                gsub(/^"/, "", $0);
                gsub(/"$/, "", $0);
                print;
                exit;
              }
            ' "$FILE")

            if [ -z "$TELEGRAM_TEXT" ]; then
              TELEGRAM_TEXT=$(first_words "$FILE" 50)
            fi

            # Escape HTML special chars for safe HTML mode
            TITLE_ESCAPED=$(printf '%s' "$TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            TELEGRAM_ESCAPED=$(printf '%s' "$TELEGRAM_TEXT" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

            # Derive the permalink from the filename and _config.yml setting:
            # permalink: /:year/:month/:day/:title/
            BASENAME=$(basename "$FILE" .md)
            YEAR=$(echo "$BASENAME" | cut -d'-' -f1)
            MONTH=$(echo "$BASENAME" | cut -d'-' -f2)
            DAY=$(echo "$BASENAME" | cut -d'-' -f3)
            SLUG=$(echo "$BASENAME" | cut -d'-' -f4-)

            POST_PATH="/${YEAR}/${MONTH}/${DAY}/${SLUG}/"
            POST_URL="${SITE_BASE_URL%/}${POST_PATH}"

            # Build HTML message:
            # Titolo in grassetto, excerpt come quote (testuale), link cliccabile "Leggi"
            # Si usano newline reali invece di \n e solo tag HTML supportati da Telegram.
            TEXT=$(printf '<b>%s</b>\n\n%s\n\n<a href="%s">Leggi il post</a>' \
              "${TITLE_ESCAPED}" \
              "${TELEGRAM_ESCAPED}" \
              "${POST_URL}")

            echo "Sending notification for $FILE -> $POST_URL"

            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${TEXT}" \
              -d "parse_mode=HTML"
          done
