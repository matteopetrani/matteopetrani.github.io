name: Notify Telegram on new post

on:
  push:
    branches:
      - main
      - master
    paths:
      - "_posts/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send Telegram notifications for new posts
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ] || [ -z "${SITE_BASE_URL}" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID or SITE_BASE_URL secrets."
            exit 1
          fi

          # Find only newly added posts in the latest commit (status "A")
          # Using git show avoids issues with missing HEAD^ on first pushes.
          CHANGED_POSTS=$(git show --name-status --pretty="" "${GITHUB_SHA}" | awk '$1 == "A" {print $2}' | grep '^_posts/' || true)

          if [ -z "$CHANGED_POSTS" ]; then
            echo "No changed posts found."
            exit 0
          fi

          for FILE in $CHANGED_POSTS; do
            if [ ! -f "$FILE" ]; then
              continue
            fi

            # Extract title from front matter (first 'title:' line)
            TITLE=$(awk '/^title:/ {sub(/^title:[ ]*/, "", $0); print; exit}' "$FILE")
            [ -z "$TITLE" ] && TITLE="Nuovo post"

            # Extract excerpt:
            # 1) Try "excerpt:" in front matter
            # 2) Otherwise, first non-empty line after front matter
            EXCERPT=$(awk '
              /^excerpt:/ {sub(/^excerpt:[ ]*/, "", $0); print; found=1; exit}
            ' "$FILE")

            if [ -z "$EXCERPT" ]; then
              EXCERPT=$(awk '
                BEGIN { in_front_matter=0; }
                /^---[ \t]*$/ {
                  if (in_front_matter==0) { in_front_matter=1; next }
                  if (in_front_matter==1) { in_front_matter=2; next }
                }
                {
                  if (in_front_matter==2 && $0 !~ /^[[:space:]]*$/) {
                    gsub(/^[[:space:]]+|[[:space:]]+$/, "", $0);
                    print $0;
                    exit;
                  }
                }
              ' "$FILE")
            fi

            [ -z "$EXCERPT" ] && EXCERPT="Nuovo post sul blog."

            # Escape HTML special chars for safe HTML mode
            TITLE_ESCAPED=$(printf '%s' "$TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            EXCERPT_ESCAPED=$(printf '%s' "$EXCERPT" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

            # Derive the permalink from the filename and _config.yml setting:
            # permalink: /:year/:month/:day/:title/
            BASENAME=$(basename "$FILE" .md)
            YEAR=$(echo "$BASENAME" | cut -d'-' -f1)
            MONTH=$(echo "$BASENAME" | cut -d'-' -f2)
            DAY=$(echo "$BASENAME" | cut -d'-' -f3)
            SLUG=$(echo "$BASENAME" | cut -d'-' -f4-)

            POST_PATH="/${YEAR}/${MONTH}/${DAY}/${SLUG}/"
            POST_URL="${SITE_BASE_URL%/}${POST_PATH}"

            # Build HTML message:
            # Titolo in grassetto, excerpt come quote (testuale), link cliccabile "Leggi"
            # Si usano newline reali invece di \n e solo tag HTML supportati da Telegram.
            TEXT=$(printf '<b>%s</b>\n&gt; %s\n<a href="%s">Leggi</a>' \
              "${TITLE_ESCAPED}" \
              "${EXCERPT_ESCAPED}" \
              "${POST_URL}")

            echo "Sending notification for $FILE -> $POST_URL"

            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${TEXT}" \
              -d "parse_mode=HTML"
          done
